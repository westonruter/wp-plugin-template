name: Update assets on WordPress.org

on:
    workflow_dispatch:
#    push:
#        branches:
#            - main
#        paths:
#            - 'README.md'
#            - '.wordpress.org/**'

jobs:
    update:
        name: Update assets
        runs-on: ubuntu-latest
        steps:
            - name: Check for SVN credentials
              id: check-secrets
              run: |
                  if [ -z "${{ secrets.SVN_USERNAME }}" ] || [ -z "${{ secrets.SVN_PASSWORD }}" ]; then
                      echo "SVN credentials not available. Skipping asset update."
                      echo "skip=true" >> $GITHUB_OUTPUT
                  else
                      echo "skip=false" >> $GITHUB_OUTPUT
                  fi

            - name: Checkout code
              if: steps.check-secrets.outputs.skip != 'true'
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            - name: Read PHP version
              if: steps.check-secrets.outputs.skip != 'true'
              id: php-version
              run: echo "version=$(jq -r .config.platform.php composer.json)" >> $GITHUB_OUTPUT

            - name: Setup PHP
              if: steps.check-secrets.outputs.skip != 'true'
              uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
              with:
                  php-version: ${{ steps.php-version.outputs.version }}
                  extensions: mbstring, dom, fileinfo, xml, curl
                  coverage: none
                  tools: composer:v2

            - name: Cache Composer dependencies
              if: steps.check-secrets.outputs.skip != 'true'
              uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: vendor
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install Composer dependencies
              if: steps.check-secrets.outputs.skip != 'true'
              run: composer install --prefer-dist --no-progress

            - name: Setup Node.js
              if: steps.check-secrets.outputs.skip != 'true'
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version-file: '.nvmrc'
                  cache: 'npm'

            - name: Install npm dependencies
              if: steps.check-secrets.outputs.skip != 'true'
              run: npm ci

            - name: Verify version consistency
              if: steps.check-secrets.outputs.skip != 'true'
              run: npm run verify-version-consistency

            - name: Transform README.md to readme.txt
              if: steps.check-secrets.outputs.skip != 'true'
              run: npm run transform-readme

            - name: Update assets
              if: steps.check-secrets.outputs.skip != 'true'
              uses: 10up/action-wordpress-plugin-asset-update@2480306f6f693672726d08b5917ea114cb2825f7 # 2.2.0
              env:
                  SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
                  SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
                  IGNORE_OTHER_FILES: true
